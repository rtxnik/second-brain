# 21.04.02 DNS Шпаргалка

> Быстрый справочник команд DNS

## Серверы

```
dns-01.rtxlab.local   10.0.20.11   (Master)
dns-02.rtxlab.local   10.0.20.12   (Slave)
```

---

## Обновление DNS записей

### На MASTER (dns-01)

```bash
# 1. Редактируем зону
sudo nano /etc/bind/zones/db.k8s.rtxlab.local

# 2. УВЕЛИЧИВАЕМ Serial!
# 2025120201 → 2025120202

# 3. Проверяем синтаксис
sudo named-checkzone k8s.rtxlab.local /etc/bind/zones/db.k8s.rtxlab.local

# 4. Применяем
sudo rndc reload k8s.rtxlab.local

# 5. Проверяем
dig @127.0.0.1 новая-запись.k8s.rtxlab.local
dig @127.0.0.1 k8s.rtxlab.local SOA +short
```

### На SLAVE (dns-02)

```bash
# Принудительный трансфер
sudo rndc retransfer k8s.rtxlab.local

# Проверка Serial
dig @127.0.0.1 k8s.rtxlab.local SOA +short
```

---

## Основные команды

### Управление зонами

```bash
sudo rndc reload k8s.rtxlab.local    # Reload зоны
sudo rndc reload                      # Reload всех зон
sudo rndc retransfer k8s.rtxlab.local # Zone transfer (slave)
sudo rndc zonestatus k8s.rtxlab.local # Статус зоны
sudo rndc status                      # Статус BIND
sudo rndc flush                       # Очистить кэш
```

### Проверка конфигурации

```bash
sudo named-checkconf                  # Проверка named.conf
sudo named-checkconf -z               # С зонами
sudo named-checkzone k8s.rtxlab.local /etc/bind/zones/db.k8s.rtxlab.local
```

### Управление сервисом

```bash
sudo systemctl status bind9
sudo systemctl restart bind9
sudo systemctl reload bind9
sudo journalctl -u bind9 -f
```

---

## Тестирование

```bash
# Простой запрос
dig @10.0.20.11 api.k8s.rtxlab.local

# Краткий ответ
dig @10.0.20.11 api.k8s.rtxlab.local +short

# SOA (проверка Serial)
dig @10.0.20.11 k8s.rtxlab.local SOA +short

# Обратный запрос
dig @10.0.20.11 -x 10.0.20.25

# Wildcard тест
dig @10.0.20.11 grafana.apps.prod.k8s.rtxlab.local
```

---

## Формат Serial

```
YYYYMMDDNN

2025120201
└┬┘└┬┘└┬┘└┬┘
 │   │  │  └─ Номер изменения за день (01-99)
 │   │  └──── День (01-31)
 │   └─────── Месяц (01-12)
 └─────────── Год
```

---

## Файлы конфигурации

### Master (dns-01)

```
/etc/bind/named.conf.options
/etc/bind/named.conf.local
/etc/bind/zones/db.rtxlab.local
/etc/bind/zones/db.k8s.rtxlab.local
/etc/bind/zones/db.20.0.10
```

### Slave (dns-02)

```
/etc/bind/named.conf.options
/etc/bind/named.conf.local
/var/cache/bind/db.*              # Реплицированные зоны
```

---

## Типы записей

```bind
hostname    IN    A       10.0.20.30     ; IPv4 адрес
alias       IN    CNAME   hostname.k8s.rtxlab.local.
30          IN    PTR     hostname.k8s.rtxlab.local.
*.apps      IN    A       10.0.20.26     ; Wildcard
```

---

## Troubleshooting

```bash
# Serial не обновляется на slave
sudo rndc retransfer k8s.rtxlab.local

# BIND не запускается
sudo named-checkconf -z
sudo journalctl -u bind9 -n 50
sudo ss -tulpn | grep :53

# Запись не резолвится
sudo cat /etc/bind/zones/db.k8s.rtxlab.local | grep hostname
sudo rndc reload k8s.rtxlab.local
```

---

**Важно:** Всегда увеличивай Serial при любых изменениях!

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.04.00 DNS]]
[[21.04.01 BIND9 Полное руководство]]
