# 21.04.01 BIND9 Полное руководство

> Установка и настройка BIND9 DNS сервера

## Развертывание DNS-01 (Master)

### 1. Базовая настройка системы

```bash
# Hostname
sudo hostnamectl set-hostname dns-01

# /etc/hosts
sudo nano /etc/hosts
```

```
127.0.0.1 localhost
10.0.20.11 dns-01.rtxlab.local dns-01
10.0.20.12 dns-02.rtxlab.local dns-02
```

### 2. Установка BIND9

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y bind9 bind9utils bind9-doc dnsutils
named -v
```

### 3. Отключение systemd-resolved

```bash
sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved
sudo rm /etc/resolv.conf

sudo nano /etc/resolv.conf
```

```
nameserver 127.0.0.1
nameserver 1.1.1.1
search rtxlab.local
```

```bash
sudo chattr +i /etc/resolv.conf
```

### 4. Настройка BIND для IPv4

```bash
sudo nano /etc/default/named
```

```
OPTIONS="-u bind -4"
```

### 5. named.conf.options

```bash
sudo nano /etc/bind/named.conf.options
```

```c
acl "trusted" {
    localhost;
    10.0.10.0/24;    // Management VLAN
    10.0.20.0/24;    // Services VLAN
    10.0.30.0/24;    // Storage VLAN
    10.0.40.0/24;    // IoT/RPi VLAN
    10.0.50.0/24;    // DMZ VLAN
};

options {
    directory "/var/cache/bind";

    listen-on { any; };
    listen-on-v6 { none; };

    allow-query { trusted; };

    recursion yes;
    allow-recursion { trusted; };

    forwarders {
        1.1.1.1;
        8.8.8.8;
    };

    dnssec-validation no;
    allow-transfer { 10.0.20.12; };
    auth-nxdomain no;
};
```

### 6. Создание директории зон

```bash
sudo mkdir -p /etc/bind/zones
sudo chown bind:bind /etc/bind/zones
```

### 7. Файлы зон

#### /etc/bind/zones/db.rtxlab.local

```bind
$TTL    86400
@       IN      SOA     dns-01.rtxlab.local. admin.rtxlab.local. (
                        2025120201      ; Serial (YYYYMMDDNN)
                        3600            ; Refresh
                        1800            ; Retry
                        604800          ; Expire
                        86400 )         ; Negative Cache TTL

; Name servers
@       IN      NS      dns-01.rtxlab.local.
@       IN      NS      dns-02.rtxlab.local.

; DNS servers
dns-01  IN      A       10.0.20.11
dns-02  IN      A       10.0.20.12

; Proxmox cluster
pve-compute-01  IN      A       10.0.10.11
pve-compute-02  IN      A       10.0.10.12
pve-compute-03  IN      A       10.0.10.13

; Gateway
gateway         IN      A       10.0.20.1
opnsense        IN      A       10.0.10.1

; TrueNAS
truenas         IN      A       10.0.10.20
```

#### /etc/bind/zones/db.k8s.rtxlab.local

```bind
$TTL    86400
@       IN      SOA     dns-01.rtxlab.local. admin.rtxlab.local. (
                        2025120201      ; Serial
                        3600            ; Refresh
                        1800            ; Retry
                        604800          ; Expire
                        86400 )         ; Negative Cache TTL

; Name servers
@       IN      NS      dns-01.rtxlab.local.
@       IN      NS      dns-02.rtxlab.local.

; Production K8s Cluster
k8s-prod-master-1    IN  A   10.0.20.20
k8s-prod-master-2    IN  A   10.0.20.21
k8s-prod-master-3    IN  A   10.0.20.22
k8s-prod-api         IN  A   10.0.20.25
k8s-prod-ingress-1   IN  A   10.0.20.30
k8s-prod-worker-1    IN  A   10.0.20.31
k8s-prod-worker-2    IN  A   10.0.20.32

; Wildcard для production apps
*.apps.prod          IN  A   10.0.20.30

; Test K8s Cluster
k8s-test-master-1    IN  A   10.0.20.40
k8s-test-master-2    IN  A   10.0.20.41
k8s-test-master-3    IN  A   10.0.20.42
k8s-test-api         IN  A   10.0.20.45
k8s-test-ingress-1   IN  A   10.0.20.50
k8s-test-worker-1    IN  A   10.0.20.51
k8s-test-worker-2    IN  A   10.0.20.52

; Wildcard для test apps
*.apps.test          IN  A   10.0.20.50
```

#### /etc/bind/zones/db.20.0.10

```bind
$TTL    86400
@       IN      SOA     dns-01.rtxlab.local. admin.rtxlab.local. (
                        2025120201      ; Serial
                        3600            ; Refresh
                        1800            ; Retry
                        604800          ; Expire
                        86400 )         ; Negative Cache TTL

; Name servers
@       IN      NS      dns-01.rtxlab.local.
@       IN      NS      dns-02.rtxlab.local.

; PTR records
11      IN      PTR     dns-01.rtxlab.local.
12      IN      PTR     dns-02.rtxlab.local.
20      IN      PTR     k8s-prod-master-1.k8s.rtxlab.local.
25      IN      PTR     k8s-prod-api.k8s.rtxlab.local.
30      IN      PTR     k8s-prod-ingress-1.k8s.rtxlab.local.
40      IN      PTR     k8s-test-master-1.k8s.rtxlab.local.
45      IN      PTR     k8s-test-api.k8s.rtxlab.local.
50      IN      PTR     k8s-test-ingress-1.k8s.rtxlab.local.
```

### 8. named.conf.local (Master)

```bash
sudo nano /etc/bind/named.conf.local
```

```c
zone "rtxlab.local" {
    type master;
    file "/etc/bind/zones/db.rtxlab.local";
    allow-transfer { 10.0.20.12; };
    notify yes;
};

zone "k8s.rtxlab.local" {
    type master;
    file "/etc/bind/zones/db.k8s.rtxlab.local";
    allow-transfer { 10.0.20.12; };
    notify yes;
};

zone "20.0.10.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.20.0.10";
    allow-transfer { 10.0.20.12; };
    notify yes;
};
```

### 9. Проверка и запуск

```bash
sudo named-checkconf
sudo named-checkzone rtxlab.local /etc/bind/zones/db.rtxlab.local
sudo named-checkzone k8s.rtxlab.local /etc/bind/zones/db.k8s.rtxlab.local
sudo named-checkzone 20.0.10.in-addr.arpa /etc/bind/zones/db.20.0.10

sudo systemctl restart bind9
sudo systemctl enable bind9
```

---

## Развертывание DNS-02 (Slave)

### named.conf.local (Slave)

```c
zone "rtxlab.local" {
    type slave;
    file "/var/cache/bind/db.rtxlab.local";
    masters { 10.0.20.11; };
};

zone "k8s.rtxlab.local" {
    type slave;
    file "/var/cache/bind/db.k8s.rtxlab.local";
    masters { 10.0.20.11; };
};

zone "20.0.10.in-addr.arpa" {
    type slave;
    file "/var/cache/bind/db.20.0.10";
    masters { 10.0.20.11; };
};
```

---

## Обновление DNS записей

### Процедура

1. SSH на dns-01 (Master)
2. Редактировать файл зоны
3. **УВЕЛИЧИТЬ Serial!** (обязательно)
4. Проверить синтаксис
5. Reload зоны
6. Проверить на slave

```bash
# На Master
sudo nano /etc/bind/zones/db.k8s.rtxlab.local
# Увеличить Serial: 2025120201 → 2025120202

sudo named-checkzone k8s.rtxlab.local /etc/bind/zones/db.k8s.rtxlab.local
sudo rndc reload k8s.rtxlab.local

# Проверка
dig @127.0.0.1 k8s.rtxlab.local SOA +short

# На Slave (dns-02)
sudo rndc retransfer k8s.rtxlab.local
dig @127.0.0.1 k8s.rtxlab.local SOA +short
```

---

## Troubleshooting

### BIND не запускается

```bash
sudo named-checkconf -z
sudo journalctl -u bind9 -n 50
sudo ss -tulpn | grep :53
```

### Slave не получает обновления

```bash
# Проверить Serial на обоих
dig @10.0.20.11 k8s.rtxlab.local SOA +short
dig @10.0.20.12 k8s.rtxlab.local SOA +short

# Принудительный трансфер на slave
sudo rndc retransfer k8s.rtxlab.local
```

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.04.00 DNS]]
[[21.04.02 DNS Шпаргалка]]
