# 21.02.04 OPNsense

> Настройка firewall и routing

## Общая информация

| Параметр   | Значение                  |
| ---------- | ------------------------- |
| Устройство | Qotom Mini PC             |
| OS         | OPNsense                  |
| Web UI     | https://10.0.10.1         |
| WAN        | Порт 1 (к Keenetic)       |
| LAN        | Порт 2 (trunk к MikroTik) |

---

## Интерфейсы

| Интерфейс | VLAN | IP               | Назначение   |
| --------- | ---- | ---------------- | ------------ |
| WAN       | -    | DHCP от Keenetic | Интернет     |
| LAN       | -    | -                | Trunk parent |
| VLAN10    | 10   | 10.0.10.1/24     | Management   |
| VLAN20    | 20   | 10.0.20.1/24     | Services     |
| VLAN30    | 30   | 10.0.30.1/24     | Storage      |
| VLAN40    | 40   | 10.0.40.1/24     | IoT          |
| VLAN50    | 50   | 10.0.50.1/24     | DMZ          |

---

## DHCP

| VLAN | Pool            | Lease   |
| ---- | --------------- | ------- |
| 10   | 10.0.10.100-200 | 24h     |
| 20   | 10.0.20.100-200 | 24h     |
| 30   | -               | Статика |
| 40   | 10.0.40.100-200 | 24h     |
| 50   | 10.0.50.100-200 | 24h     |

---

## DNS

```
Mode:       DNS Forwarder
Upstream:   10.0.20.11, 10.0.20.12 (BIND серверы)
Fallback:   1.1.1.1, 8.8.8.8
```

---

## VPN

| Тип       | Статус         | Сеть          |
| --------- | -------------- | ------------- |
| OpenVPN   | ✅ Настроен    | 10.10.10.0/24 |
| WireGuard | ⏳ Планируется | -             |

---

## Firewall правила

### Текущий статус

⚠️ Базовая настройка - все VLANs могут общаться между собой

### Планируемые правила

| От     | К        | Действие | Описание                 |
| ------ | -------- | -------- | ------------------------ |
| VLAN10 | Все      | Allow    | Management полный доступ |
| VLAN20 | VLAN30   | Allow    | K8s → Storage            |
| VLAN20 | WAN      | Allow    | K8s → Internet           |
| VLAN40 | VLAN20   | Deny     | IoT изоляция             |
| VLAN50 | Internal | Deny     | DMZ изоляция             |

---

## TODO

- [ ] Настроить firewall правила между VLANs
- [ ] Настроить WireGuard VPN
- [ ] Настроить IDS/IPS (Suricata)

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.02.00 Сеть]]
[[21.01.02 Сетевое оборудование]]
