# 21.03.01 Кластер

> Настройка и управление Proxmox кластером

## Параметры кластера

| Параметр      | Значение        |
| ------------- | --------------- |
| Имя           | homelab-cluster |
| Ноды          | 3               |
| Quorum        | 2 (из 3)        |
| Corosync сеть | 10.0.11.0/24    |

---

## Ноды

| Нода           | Management IP | Cluster IP | Роль            |
| -------------- | ------------- | ---------- | --------------- |
| pve-compute-01 | 10.0.10.11    | 10.0.11.11 | Master (первая) |
| pve-compute-02 | 10.0.10.12    | 10.0.11.12 | Member          |
| pve-compute-03 | 10.0.10.13    | 10.0.11.13 | Member          |

---

## Сетевая конфигурация нод

### /etc/network/interfaces

```bash
# Management + VM Traffic (VLAN-aware)
auto vmbr0
iface vmbr0 inet static
    address 10.0.10.11/24  # .12 или .13 для других нод
    gateway 10.0.10.1
    bridge-ports eth0
    bridge-stp off
    bridge-fd 0
    bridge-vlan-aware yes
    bridge-vids 10 20 30 40 50

# Cluster/Ceph Network
auto vmbr1
iface vmbr1 inet static
    address 10.0.11.11/24  # .12 или .13 для других нод
    bridge-ports eth1
    bridge-stp off
    bridge-fd 0
```

---

## Создание кластера

### На первой ноде (pve-compute-01)

```bash
# Создать кластер
pvecm create homelab-cluster

# Проверить статус
pvecm status
```

### На остальных нодах

```bash
# Присоединиться к кластеру
pvecm add 10.0.11.11

# Проверить статус
pvecm status
pvecm nodes
```

---

## Corosync

### Конфигурация /etc/pve/corosync.conf

```
totem {
    version: 2
    cluster_name: homelab-cluster
    transport: knet

    interface {
        linknumber: 0
        knet_link_priority: 1
    }
}

nodelist {
    node {
        name: pve-compute-01
        nodeid: 1
        ring0_addr: 10.0.11.11
    }
    node {
        name: pve-compute-02
        nodeid: 2
        ring0_addr: 10.0.11.12
    }
    node {
        name: pve-compute-03
        nodeid: 3
        ring0_addr: 10.0.11.13
    }
}

quorum {
    provider: corosync_votequorum
}
```

---

## High Availability

### Включение HA

```bash
# Через GUI: Datacenter → HA → Groups
# Или CLI:
ha-manager groupadd ha-group -nodes pve-compute-01,pve-compute-02,pve-compute-03
```

### HA для VM

```bash
# Добавить VM в HA
ha-manager add vm:100 -group ha-group -state started

# Проверить статус
ha-manager status
```

---

## Полезные команды

```bash
# Статус кластера
pvecm status

# Список нод
pvecm nodes

# Статус quorum
pvecm expected 2

# Удалить ноду (ОСТОРОЖНО!)
pvecm delnode <nodename>

# Проверка corosync
systemctl status corosync
corosync-cfgtool -s

# HA статус
ha-manager status
```

---

## Troubleshooting

### Потеря quorum

```bash
# Временно установить expected votes
pvecm expected 1

# После восстановления нод
pvecm expected 2
```

### Проблемы с corosync

```bash
# Логи
journalctl -u corosync -f

# Проверка связности
ping -I vmbr1 10.0.11.12
```

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.03.00 Proxmox]]
[[21.03.02 Ceph]]
