# 21.03.03 VM Templates

> Cloud-init шаблоны для быстрого развёртывания VM

## Ubuntu 24.04 Server Template

| Параметр    | Значение                 |
| ----------- | ------------------------ |
| Template ID | 9000                     |
| OS          | Ubuntu 24.04 LTS (Noble) |
| Image       | Cloud Image (QCOW2)      |
| Storage     | ceph-pool                |

---

## Создание шаблона

### 1. Скачать Cloud Image

```bash
cd /var/lib/vz/template/iso/
wget https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img
```

### 2. Создать VM

```bash
qm create 9000 --name ubuntu-24.04-template --memory 2048 --cores 2 --net0 virtio,bridge=vmbr0

# Импортировать диск
qm importdisk 9000 noble-server-cloudimg-amd64.img ceph-pool

# Подключить диск
qm set 9000 --scsihw virtio-scsi-pci --scsi0 ceph-pool:vm-9000-disk-0

# Cloud-init drive
qm set 9000 --ide2 ceph-pool:cloudinit

# Boot order
qm set 9000 --boot c --bootdisk scsi0

# Serial console (для cloud-init)
qm set 9000 --serial0 socket --vga serial0

# QEMU Guest Agent
qm set 9000 --agent enabled=1
```

### 3. Cloud-Init настройки

```bash
# Через GUI: VM → Cloud-Init
# Или CLI:
qm set 9000 --ciuser admin
qm set 9000 --cipassword <password>
qm set 9000 --sshkeys ~/.ssh/id_rsa.pub
qm set 9000 --ipconfig0 ip=dhcp
qm set 9000 --nameserver 10.0.20.11
qm set 9000 --searchdomain rtxlab.local
```

### 4. Подготовка образа

```bash
# Запустить VM, установить пакеты
qm start 9000

# Внутри VM:
sudo apt update && sudo apt upgrade -y
sudo apt install -y qemu-guest-agent curl vim htop

# Для Kubernetes:
sudo apt install -y apt-transport-https ca-certificates

# Kernel modules
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
overlay
EOF

# Sysctl
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward = 1
EOF

# Отключить swap
sudo swapoff -a
sudo sed -i '/ swap / s/^/#/' /etc/fstab

# Очистка
sudo apt clean
sudo cloud-init clean

# Выключить
sudo shutdown -h now
```

### 5. Конвертировать в template

```bash
qm template 9000
```

---

## Клонирование VM

### Через CLI

```bash
# Full clone
qm clone 9000 101 --name k8s-test-master-1 --full

# Настроить ресурсы
qm set 101 --memory 4096 --cores 2
qm set 101 --ipconfig0 ip=10.0.20.40/24,gw=10.0.20.1
```

### Через OpenTofu

См. [[21.07.01 OpenTofu]]

---

## Спецификации VM для Kubernetes

### Production Cluster

| Роль    | RAM  | vCPU | Disk  |
| ------- | ---- | ---- | ----- |
| Master  | 8GB  | 4    | 50GB  |
| Ingress | 4GB  | 2    | 30GB  |
| Worker  | 24GB | 6    | 100GB |

### Test Cluster

| Роль    | RAM | vCPU | Disk |
| ------- | --- | ---- | ---- |
| Master  | 4GB | 2    | 30GB |
| Ingress | 2GB | 2    | 20GB |
| Worker  | 8GB | 4    | 50GB |

---

## Статус

- [ ] Ubuntu 24.04 Cloud Image скачан
- [ ] Template 9000 создан
- [ ] Cloud-init настроен
- [ ] K8s prerequisites установлены
- [ ] Template протестирован

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.03.00 Proxmox]]
[[21.07.01 OpenTofu]]
[[21.05.00 Kubernetes]]
