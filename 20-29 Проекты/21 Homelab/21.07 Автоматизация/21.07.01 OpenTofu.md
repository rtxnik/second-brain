# 21.07.01 OpenTofu

> Infrastructure as Code для Proxmox

## Что такое OpenTofu

OpenTofu - open-source форк Terraform. Используется для декларативного управления инфраструктурой через Proxmox API.

---

## Структура проекта

```
homelab-tofu/
├── modules/
│   └── proxmox-vm/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf
├── environments/
│   ├── test-cluster/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   └── prod-cluster/
│       ├── main.tf
│       ├── variables.tf
│       └── terraform.tfvars
├── .gitignore
└── README.md
```

---

## Provider Configuration

### providers.tf

```hcl
terraform {
  required_providers {
    proxmox = {
      source  = "bpg/proxmox"
      version = "~> 0.46"
    }
  }
}

provider "proxmox" {
  endpoint = "https://10.0.10.11:8006"
  username = "root@pam"
  password = var.proxmox_password
  insecure = true

  ssh {
    agent = true
  }
}
```

### variables.tf

```hcl
variable "proxmox_password" {
  description = "Proxmox root password"
  type        = string
  sensitive   = true
}
```

---

## VM Module

### modules/proxmox-vm/main.tf

```hcl
resource "proxmox_virtual_environment_vm" "vm" {
  name        = var.vm_name
  description = var.description
  tags        = var.tags

  node_name = var.target_node

  clone {
    vm_id = var.template_id
    full  = true
  }

  cpu {
    cores = var.cores
    type  = "host"
  }

  memory {
    dedicated = var.memory
  }

  disk {
    datastore_id = var.storage
    interface    = "scsi0"
    size         = var.disk_size
    iothread     = true
    discard      = "on"
  }

  network_device {
    bridge  = "vmbr0"
    vlan_id = var.vlan_id
  }

  initialization {
    ip_config {
      ipv4 {
        address = "${var.ip_address}/24"
        gateway = var.gateway
      }
    }

    dns {
      servers = ["10.0.20.11", "10.0.20.12"]
      domain  = "rtxlab.local"
    }

    user_account {
      username = var.ssh_user
      keys     = [var.ssh_public_key]
    }
  }

  agent {
    enabled = true
  }
}
```

### modules/proxmox-vm/variables.tf

```hcl
variable "vm_name" {
  type = string
}

variable "description" {
  type    = string
  default = ""
}

variable "tags" {
  type    = list(string)
  default = []
}

variable "target_node" {
  type = string
}

variable "template_id" {
  type    = number
  default = 9000
}

variable "cores" {
  type    = number
  default = 2
}

variable "memory" {
  type    = number
  default = 2048
}

variable "disk_size" {
  type    = number
  default = 20
}

variable "storage" {
  type    = string
  default = "ceph-pool"
}

variable "vlan_id" {
  type    = number
  default = 20
}

variable "ip_address" {
  type = string
}

variable "gateway" {
  type    = string
  default = "10.0.20.1"
}

variable "ssh_user" {
  type    = string
  default = "admin"
}

variable "ssh_public_key" {
  type = string
}
```

---

## Test Cluster Deployment

### environments/test-cluster/main.tf

```hcl
module "k8s_test_masters" {
  source   = "../../modules/proxmox-vm"
  for_each = {
    "k8s-test-master-1" = { ip = "10.0.20.40", node = "pve-compute-01" }
    "k8s-test-master-2" = { ip = "10.0.20.41", node = "pve-compute-02" }
    "k8s-test-master-3" = { ip = "10.0.20.42", node = "pve-compute-03" }
  }

  vm_name        = each.key
  target_node    = each.value.node
  ip_address     = each.value.ip
  cores          = 2
  memory         = 4096
  disk_size      = 30
  tags           = ["k8s", "test", "master"]
  ssh_public_key = var.ssh_public_key
}

module "k8s_test_ingress" {
  source = "../../modules/proxmox-vm"

  vm_name        = "k8s-test-ingress-1"
  target_node    = "pve-compute-01"
  ip_address     = "10.0.20.50"
  cores          = 2
  memory         = 2048
  disk_size      = 20
  tags           = ["k8s", "test", "ingress"]
  ssh_public_key = var.ssh_public_key
}

module "k8s_test_workers" {
  source   = "../../modules/proxmox-vm"
  for_each = {
    "k8s-test-worker-1" = { ip = "10.0.20.51", node = "pve-compute-02" }
    "k8s-test-worker-2" = { ip = "10.0.20.52", node = "pve-compute-03" }
  }

  vm_name        = each.key
  target_node    = each.value.node
  ip_address     = each.value.ip
  cores          = 4
  memory         = 8192
  disk_size      = 50
  tags           = ["k8s", "test", "worker"]
  ssh_public_key = var.ssh_public_key
}
```

---

## Команды

```bash
# Инициализация
cd environments/test-cluster
tofu init

# Планирование
tofu plan -var-file="terraform.tfvars"

# Применение
tofu apply -var-file="terraform.tfvars"

# Уничтожение
tofu destroy -var-file="terraform.tfvars"

# Показать состояние
tofu show
tofu state list
```

---

## Secrets

### terraform.tfvars (НЕ коммитить!)

```hcl
proxmox_password = "your-password"
ssh_public_key   = "ssh-rsa AAAA..."
```

### .gitignore

```
*.tfvars
*.tfstate
*.tfstate.*
.terraform/
```

---

## Статус

- [x] Proxmox provider настроен
- [x] VM module создан
- [ ] Test cluster конфигурация
- [ ] Production cluster конфигурация
- [ ] Backend для state (S3/local)

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.07.00 Автоматизация]]
[[21.03.03 VM Templates]]
[[21.05.00 Kubernetes]]
