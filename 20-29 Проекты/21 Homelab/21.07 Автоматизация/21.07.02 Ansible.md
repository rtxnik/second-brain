# 21.07.02 Ansible

> Configuration management для homelab

## Структура проекта

```
homelab-ansible/
├── ansible.cfg
├── inventory/
│   ├── hosts.yml
│   └── group_vars/
│       ├── all.yml
│       ├── proxmox.yml
│       ├── dns.yml
│       └── k8s.yml
├── playbooks/
│   ├── site.yml
│   ├── proxmox.yml
│   ├── dns.yml
│   └── k8s-prep.yml
├── roles/
│   ├── common/
│   ├── docker/
│   ├── k8s-prereq/
│   └── monitoring/
└── README.md
```

---

## Inventory

### inventory/hosts.yml

```yaml
all:
  children:
    proxmox:
      hosts:
        pve-compute-01:
          ansible_host: 10.0.10.11
        pve-compute-02:
          ansible_host: 10.0.10.12
        pve-compute-03:
          ansible_host: 10.0.10.13

    dns:
      hosts:
        dns-01:
          ansible_host: 10.0.20.11
          dns_role: master
        dns-02:
          ansible_host: 10.0.20.12
          dns_role: slave

    k8s_test:
      children:
        k8s_test_masters:
          hosts:
            k8s-test-master-1:
              ansible_host: 10.0.20.40
            k8s-test-master-2:
              ansible_host: 10.0.20.41
            k8s-test-master-3:
              ansible_host: 10.0.20.42
        k8s_test_workers:
          hosts:
            k8s-test-ingress-1:
              ansible_host: 10.0.20.50
            k8s-test-worker-1:
              ansible_host: 10.0.20.51
            k8s-test-worker-2:
              ansible_host: 10.0.20.52

    k8s_prod:
      children:
        k8s_prod_masters:
          hosts:
            k8s-prod-master-1:
              ansible_host: 10.0.20.20
            k8s-prod-master-2:
              ansible_host: 10.0.20.21
            k8s-prod-master-3:
              ansible_host: 10.0.20.22
        k8s_prod_workers:
          hosts:
            k8s-prod-ingress-1:
              ansible_host: 10.0.20.30
            k8s-prod-worker-1:
              ansible_host: 10.0.20.31
            k8s-prod-worker-2:
              ansible_host: 10.0.20.32
```

---

## ansible.cfg

```ini
[defaults]
inventory = inventory/hosts.yml
remote_user = admin
private_key_file = ~/.ssh/id_rsa
host_key_checking = False
retry_files_enabled = False

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
```

---

## Playbooks

### playbooks/k8s-prep.yml

```yaml
---
- name: Prepare nodes for Kubernetes
  hosts: k8s_test:k8s_prod
  become: yes

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - qemu-guest-agent
        state: present

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay

    - name: Persist kernel modules
      copy:
        content: |
          br_netfilter
          overlay
        dest: /etc/modules-load.d/k8s.conf

    - name: Set sysctl parameters
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
      loop:
        - { key: "net.bridge.bridge-nf-call-iptables", value: "1" }
        - { key: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
        - { key: "net.ipv4.ip_forward", value: "1" }

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: ".*swap.*"
        state: absent

    - name: Start qemu-guest-agent
      service:
        name: qemu-guest-agent
        state: started
        enabled: yes
```

---

## Полезные команды

```bash
# Проверка inventory
ansible-inventory --list

# Ping всех хостов
ansible all -m ping

# Запуск playbook
ansible-playbook playbooks/k8s-prep.yml

# Только для test кластера
ansible-playbook playbooks/k8s-prep.yml --limit k8s_test

# Dry run
ansible-playbook playbooks/k8s-prep.yml --check

# Verbose
ansible-playbook playbooks/k8s-prep.yml -vvv

# Ad-hoc команды
ansible proxmox -m shell -a "uptime"
ansible k8s_test -m shell -a "cat /etc/os-release"
```

---

## Роли

### roles/common/tasks/main.yml

```yaml
---
- name: Set timezone
  timezone:
    name: Europe/Moscow

- name: Install common packages
  apt:
    name:
      - vim
      - htop
      - curl
      - wget
      - net-tools
      - dnsutils
    state: present

- name: Configure SSH
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
  notify: restart sshd
```

---

## Интеграция с OpenTofu

```
1. OpenTofu создаёт VMs
2. OpenTofu генерирует dynamic inventory (JSON)
3. Ansible читает inventory
4. Ansible конфигурирует VMs
5. Kubespray деплоит K8s
```

---

## Статус

- [ ] Inventory создан
- [ ] Common role готова
- [ ] K8s-prereq playbook готов
- [ ] Интеграция с OpenTofu
- [ ] Тестирование на test cluster

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.07.00 Автоматизация]]
[[21.07.01 OpenTofu]]
[[21.05.03 Kubespray]]
