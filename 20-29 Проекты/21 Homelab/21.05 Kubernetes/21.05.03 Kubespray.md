# 21.05.03 Kubespray

> Автоматизированный деплой Kubernetes через Ansible

## Что такое Kubespray

Kubespray - набор Ansible плейбуков для развёртывания production-ready Kubernetes кластера. Поддерживает:

- HA control plane с несколькими masters
- Различные CNI плагины (Calico, Flannel, Cilium)
- Различные container runtimes (containerd, CRI-O)
- Масштабирование кластера

---

## Подготовка

### 1. Клонирование репозитория

```bash
git clone https://github.com/kubernetes-sigs/kubespray.git
cd kubespray
git checkout release-2.24  # или актуальная версия
```

### 2. Python окружение

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 3. Копирование sample inventory

```bash
cp -rfp inventory/sample inventory/homelab-prod
cp -rfp inventory/sample inventory/homelab-test
```

---

## Production Inventory

### inventory/homelab-prod/hosts.yaml

```yaml
all:
  hosts:
    k8s-prod-master-1:
      ansible_host: 10.0.20.20
      ip: 10.0.20.20
      access_ip: 10.0.20.20
    k8s-prod-master-2:
      ansible_host: 10.0.20.21
      ip: 10.0.20.21
      access_ip: 10.0.20.21
    k8s-prod-master-3:
      ansible_host: 10.0.20.22
      ip: 10.0.20.22
      access_ip: 10.0.20.22
    k8s-prod-ingress-1:
      ansible_host: 10.0.20.30
      ip: 10.0.20.30
      access_ip: 10.0.20.30
    k8s-prod-worker-1:
      ansible_host: 10.0.20.31
      ip: 10.0.20.31
      access_ip: 10.0.20.31
    k8s-prod-worker-2:
      ansible_host: 10.0.20.32
      ip: 10.0.20.32
      access_ip: 10.0.20.32
  children:
    kube_control_plane:
      hosts:
        k8s-prod-master-1:
        k8s-prod-master-2:
        k8s-prod-master-3:
    kube_node:
      hosts:
        k8s-prod-ingress-1:
        k8s-prod-worker-1:
        k8s-prod-worker-2:
    etcd:
      hosts:
        k8s-prod-master-1:
        k8s-prod-master-2:
        k8s-prod-master-3:
    k8s_cluster:
      children:
        kube_control_plane:
        kube_node:
    calico_rr:
      hosts: {}
```

---

## Test Inventory

### inventory/homelab-test/hosts.yaml

```yaml
all:
  hosts:
    k8s-test-master-1:
      ansible_host: 10.0.20.40
      ip: 10.0.20.40
      access_ip: 10.0.20.40
    k8s-test-master-2:
      ansible_host: 10.0.20.41
      ip: 10.0.20.41
      access_ip: 10.0.20.41
    k8s-test-master-3:
      ansible_host: 10.0.20.42
      ip: 10.0.20.42
      access_ip: 10.0.20.42
    k8s-test-ingress-1:
      ansible_host: 10.0.20.50
      ip: 10.0.20.50
      access_ip: 10.0.20.50
    k8s-test-worker-1:
      ansible_host: 10.0.20.51
      ip: 10.0.20.51
      access_ip: 10.0.20.51
    k8s-test-worker-2:
      ansible_host: 10.0.20.52
      ip: 10.0.20.52
      access_ip: 10.0.20.52
  children:
    kube_control_plane:
      hosts:
        k8s-test-master-1:
        k8s-test-master-2:
        k8s-test-master-3:
    kube_node:
      hosts:
        k8s-test-ingress-1:
        k8s-test-worker-1:
        k8s-test-worker-2:
    etcd:
      hosts:
        k8s-test-master-1:
        k8s-test-master-2:
        k8s-test-master-3:
    k8s_cluster:
      children:
        kube_control_plane:
        kube_node:
    calico_rr:
      hosts: {}
```

---

## Group Variables

### group_vars/all/all.yml

```yaml
# Базовые настройки
cluster_name: homelab-prod # или homelab-test
download_run_once: true
download_localhost: true

# DNS
dns_domain: cluster.local
upstream_dns_servers:
  - 10.0.20.11
  - 10.0.20.12

# Сеть
kube_network_plugin: calico
kube_pods_subnet: 10.233.64.0/18
kube_service_addresses: 10.233.0.0/18

# Container runtime
container_manager: containerd
```

### group_vars/k8s_cluster/k8s-cluster.yml

```yaml
# Kubernetes версия
kube_version: v1.29.0

# HA API
kube_apiserver_port: 6443
loadbalancer_apiserver:
  address: 10.0.20.25 # Production VIP
  port: 6443

# Для Test кластера: 10.0.20.45

# Дополнительно
kubeconfig_localhost: true
kubectl_localhost: true
```

---

## Запуск деплоя

### Проверка SSH доступа

```bash
ansible -i inventory/homelab-test/hosts.yaml all -m ping
```

### Деплой Test кластера

```bash
ansible-playbook -i inventory/homelab-test/hosts.yaml \
  --become --become-user=root \
  cluster.yml
```

### Деплой Production кластера

```bash
ansible-playbook -i inventory/homelab-prod/hosts.yaml \
  --become --become-user=root \
  cluster.yml
```

---

## Управление кластером

### Добавление ноды

```bash
ansible-playbook -i inventory/homelab-prod/hosts.yaml \
  --become --become-user=root \
  scale.yml
```

### Удаление ноды

```bash
ansible-playbook -i inventory/homelab-prod/hosts.yaml \
  --become --become-user=root \
  remove-node.yml \
  -e node=k8s-prod-worker-2
```

### Обновление кластера

```bash
ansible-playbook -i inventory/homelab-prod/hosts.yaml \
  --become --become-user=root \
  upgrade-cluster.yml
```

### Сброс кластера

```bash
ansible-playbook -i inventory/homelab-prod/hosts.yaml \
  --become --become-user=root \
  reset.yml
```

---

## Post-install

### Получение kubeconfig

```bash
# Kubeconfig будет в inventory/homelab-prod/artifacts/admin.conf
mkdir -p ~/.kube
cp inventory/homelab-prod/artifacts/admin.conf ~/.kube/config-prod
```

### Проверка кластера

```bash
export KUBECONFIG=~/.kube/config-prod
kubectl get nodes
kubectl get pods -A
```

---

## Troubleshooting

### Логи Ansible

```bash
# Verbose mode
ansible-playbook ... -vvv

# Только конкретные таски
ansible-playbook ... --tags download
ansible-playbook ... --tags network
```

### Проблемы с etcd

```bash
# На master ноде
etcdctl member list
etcdctl endpoint health
```

---

Дата создания: 02-12-2025

#### Ссылки:

[[21.05.00 Kubernetes]]
[[21.05.01 Production Cluster]]
[[21.05.02 Test Cluster]]
