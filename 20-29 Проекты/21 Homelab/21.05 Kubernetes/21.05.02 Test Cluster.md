# 21.05.02 Test Cluster

> Kubernetes Test кластер — зеркальная топология с уменьшенными ресурсами

## Топология

```
┌─────────────────────────────────────────────────────────────┐
│                     Test K8s Cluster                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│   │  Master-1   │  │  Master-2   │  │  Master-3   │        │
│   │ 10.0.20.40  │  │ 10.0.20.41  │  │ 10.0.20.42  │        │
│   │ etcd + CP   │  │ etcd + CP   │  │ etcd + CP   │        │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│          │                │                │                │
│          └────────────────┼────────────────┘                │
│                           │                                 │
│                    ┌──────┴──────┐                          │
│                    │   API VIP   │                          │
│                    │ 10.0.20.45  │                          │
│                    └─────────────┘                          │
│                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│   │  Ingress-1  │  │  Worker-1   │  │  Worker-2   │        │
│   │ 10.0.20.50  │  │ 10.0.20.51  │  │ 10.0.20.52  │        │
│   │  *.apps.test│  │  Workloads  │  │  Workloads  │        │
│   └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Ноды

| Hostname           | IP         | Роль                 | RAM | vCPU | Disk |
| ------------------ | ---------- | -------------------- | --- | ---- | ---- |
| k8s-test-master-1  | 10.0.20.40 | Control Plane + etcd | 4GB | 2    | 30GB |
| k8s-test-master-2  | 10.0.20.41 | Control Plane + etcd | 4GB | 2    | 30GB |
| k8s-test-master-3  | 10.0.20.42 | Control Plane + etcd | 4GB | 2    | 30GB |
| k8s-test-ingress-1 | 10.0.20.50 | Ingress Controller   | 2GB | 2    | 20GB |
| k8s-test-worker-1  | 10.0.20.51 | Workloads            | 8GB | 4    | 50GB |
| k8s-test-worker-2  | 10.0.20.52 | Workloads            | 8GB | 4    | 50GB |

**Итого:** 30GB RAM, 16 vCPU, 210GB disk

---

## Ключевые адреса

| Назначение    | Адрес                         |
| ------------- | ----------------------------- |
| API VIP (HA)  | 10.0.20.45                    |
| Ingress VIP   | 10.0.20.50                    |
| Wildcard Apps | \*.apps.test.k8s.rtxlab.local |

---

## DNS записи

```bind
; Test K8s Cluster
k8s-test-master-1    IN  A   10.0.20.40
k8s-test-master-2    IN  A   10.0.20.41
k8s-test-master-3    IN  A   10.0.20.42
k8s-test-api         IN  A   10.0.20.45
k8s-test-ingress-1   IN  A   10.0.20.50
k8s-test-worker-1    IN  A   10.0.20.51
k8s-test-worker-2    IN  A   10.0.20.52

; Wildcard для apps
*.apps.test          IN  A   10.0.20.50
```

---

## Сравнение с Production

| Параметр    | Production       | Test                  |
| ----------- | ---------------- | --------------------- |
| Master RAM  | 8GB              | 4GB                   |
| Master vCPU | 4                | 2                     |
| Worker RAM  | 24GB             | 8GB                   |
| Worker vCPU | 6                | 4                     |
| Общий RAM   | 76GB             | 30GB                  |
| Назначение  | Stable workloads | Testing & experiments |

---

## Назначение Test кластера

### CI/CD Pipeline

```
Code → Build → Deploy to Test → Validate → Promote to Prod
```

### Сценарии использования

- Тестирование Helm charts перед prod
- Проверка обновлений K8s версий
- Эксперименты с новыми операторами
- Нагрузочное тестирование (ограниченное)
- Обучение и практика

---

## Доступ

### kubectl

```bash
# Скопировать kubeconfig
scp admin@k8s-test-master-1:~/.kube/config ~/.kube/config-test

# Использовать
export KUBECONFIG=~/.kube/config-test
kubectl get nodes
```

### Переключение контекстов

```bash
# Объединить kubeconfigs
KUBECONFIG=~/.kube/config-prod:~/.kube/config-test kubectl config view --flatten > ~/.kube/config

# Переключение
kubectl config use-context test-cluster
kubectl config use-context prod-cluster
```

---

## Статус

- [ ] VMs созданы
- [ ] DNS записи добавлены
- [ ] Kubespray выполнен
- [ ] Кластер работает
- [ ] Ingress настроен
- [ ] Storage готов

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.05.00 Kubernetes]]
[[21.05.01 Production Cluster]]
[[21.05.03 Kubespray]]
