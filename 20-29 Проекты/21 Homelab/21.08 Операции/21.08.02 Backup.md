# 21.08.02 Backup

> Стратегия резервного копирования

## Обзор

```
┌─────────────────────────────────────────────────────────────┐
│                    Backup Architecture                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐              ┌─────────────────────┐     │
│   │  Proxmox    │              │      TrueNAS        │     │
│   │   Cluster   │──────────────│   Backup Target     │     │
│   │             │   vzdump     │                     │     │
│   └─────────────┘              │  ┌───────────────┐  │     │
│                                │  │  PBS Dataset  │  │     │
│   ┌─────────────┐              │  │  (backups)    │  │     │
│   │ Kubernetes  │──────────────│  └───────────────┘  │     │
│   │  Clusters   │   Velero     │                     │     │
│   └─────────────┘              │  ┌───────────────┐  │     │
│                                │  │  NFS Dataset  │  │     │
│   ┌─────────────┐              │  │  (files)      │  │     │
│   │   Config    │──────────────│  └───────────────┘  │     │
│   │   Files     │    rsync     │                     │     │
│   └─────────────┘              └─────────────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Что бэкапить

### Критичное (ежедневно)

| Компонент  | Метод                 | Хранение |
| ---------- | --------------------- | -------- |
| VM disks   | Proxmox Backup Server | 30 дней  |
| etcd (K8s) | Velero / etcdctl      | 14 дней  |
| DNS зоны   | rsync                 | 30 дней  |
| Конфиги    | Git + rsync           | Всегда   |

### Важное (еженедельно)

| Компонент      | Метод    | Хранение |
| -------------- | -------- | -------- |
| Full VM backup | PBS      | 4 недели |
| K8s namespaces | Velero   | 4 недели |
| TrueNAS config | Built-in | 4 недели |

### Данные (по расписанию)

| Компонент          | Метод               | Хранение |
| ------------------ | ------------------- | -------- |
| Persistent Volumes | Longhorn backup     | 14 дней  |
| Databases          | pg_dump / mysqldump | 14 дней  |
| User data          | rsync to TrueNAS    | 30 дней  |

---

## Proxmox Backup Server (PBS)

### Установка

```bash
# На TrueNAS или отдельной VM
# Скачать ISO с proxmox.com
# Установить как отдельный сервис
```

### Добавление в Proxmox

```
Datacenter → Storage → Add → Proxmox Backup Server

ID:          pbs
Server:      10.0.30.11
Username:    backup@pbs
Datastore:   backups
Fingerprint: <from PBS>
```

### Расписание бэкапов

```
Datacenter → Backup → Add

Storage:     pbs
Schedule:    daily at 02:00
Selection:   All VMs
Mode:        Snapshot
Compression: ZSTD
Retention:   keep-daily=7, keep-weekly=4, keep-monthly=2
```

---

## Velero (Kubernetes)

### Установка

```bash
# Установить Velero CLI
wget https://github.com/vmware-tanzu/velero/releases/download/v1.12.0/velero-v1.12.0-linux-amd64.tar.gz
tar -xvf velero-v1.12.0-linux-amd64.tar.gz
sudo mv velero-v1.12.0-linux-amd64/velero /usr/local/bin/

# Установить в кластер (с MinIO или S3-compatible storage)
velero install \
  --provider aws \
  --plugins velero/velero-plugin-for-aws:v1.8.0 \
  --bucket velero-backups \
  --secret-file ./credentials-velero \
  --backup-location-config region=minio,s3ForcePathStyle=true,s3Url=http://minio.storage:9000
```

### Backup команды

```bash
# Создать backup
velero backup create daily-backup --include-namespaces apps

# Проверить статус
velero backup describe daily-backup

# Восстановить
velero restore create --from-backup daily-backup

# Расписание
velero schedule create daily --schedule="0 2 * * *" --include-namespaces apps
```

---

## Конфигурации (Git + rsync)

### Что хранить в Git

```
homelab-config/
├── dns/
│   └── zones/
├── proxmox/
│   └── cluster.conf
├── opnsense/
│   └── config.xml
├── kubernetes/
│   ├── manifests/
│   └── helm-values/
└── ansible/
    └── inventory/
```

### rsync скрипт

```bash
#!/bin/bash
# /usr/local/bin/backup-configs.sh

BACKUP_DIR="/mnt/truenas/backups/configs"
DATE=$(date +%Y-%m-%d)

# DNS
rsync -avz --delete root@10.0.20.11:/etc/bind/zones/ $BACKUP_DIR/dns/$DATE/

# Proxmox
rsync -avz root@10.0.10.11:/etc/pve/ $BACKUP_DIR/proxmox/$DATE/

# Cleanup old backups (keep 30 days)
find $BACKUP_DIR -type d -mtime +30 -exec rm -rf {} \;
```

### Cron

```bash
# /etc/cron.d/backup-configs
0 3 * * * root /usr/local/bin/backup-configs.sh
```

---

## Retention Policy

| Тип          | Daily | Weekly | Monthly |
| ------------ | ----- | ------ | ------- |
| VM Snapshots | 7     | 4      | 2       |
| K8s Backups  | 7     | 4      | -       |
| Config Files | 30    | -      | 6       |
| Databases    | 7     | 4      | 2       |

---

## Восстановление

### VM из PBS

```bash
# Через GUI
Datacenter → PBS Storage → Backups → Restore

# Через CLI
qmrestore /path/to/backup.vma 100 --storage ceph-pool
```

### K8s namespace

```bash
velero restore create --from-backup daily-backup \
  --include-namespaces apps \
  --restore-volumes=true
```

### DNS зона

```bash
scp backup-server:/backups/dns/2025-12-01/db.k8s.rtxlab.local \
    root@10.0.20.11:/etc/bind/zones/
ssh root@10.0.20.11 "rndc reload"
```

---

## Тестирование бэкапов

### Ежемесячно

1. Выбрать случайную VM
2. Восстановить из backup в тестовое окружение
3. Проверить работоспособность
4. Документировать результат

### После изменений

1. Создать backup до изменений
2. Выполнить изменения
3. Проверить возможность отката

---

## Статус

- [ ] PBS установлен
- [ ] Расписание бэкапов настроено
- [ ] Velero в K8s
- [ ] rsync скрипты готовы
- [ ] Тест восстановления проведён

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.08.00 Операции]]
[[21.01.03 TrueNAS]]
[[21.03.00 Proxmox]]
