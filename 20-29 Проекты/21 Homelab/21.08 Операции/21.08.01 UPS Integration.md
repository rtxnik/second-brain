# 21.08.01 UPS Integration

> NUT (Network UPS Tools) для graceful shutdown

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    UPS Power Chain                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    ┌─────────────────┐                      │
│                    │  APC BX1600MI   │                      │
│                    │   1600VA/900W   │                      │
│                    └────────┬────────┘                      │
│                             │ USB                           │
│                             ▼                               │
│                    ┌─────────────────┐                      │
│                    │    TrueNAS      │                      │
│                    │   NUT Master    │                      │
│                    │   10.0.30.10    │                      │
│                    └────────┬────────┘                      │
│                             │ Network                       │
│              ┌──────────────┼──────────────┐                │
│              │              │              │                │
│              ▼              ▼              ▼                │
│     ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│     │pve-compute-01│ │pve-compute-02│ │pve-compute-03│     │
│     │  NUT Slave   │ │  NUT Slave   │ │  NUT Slave   │     │
│     │  10.0.10.11  │ │  10.0.10.12  │ │  10.0.10.13  │     │
│     └──────────────┘ └──────────────┘ └──────────────┘     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Конфигурация TrueNAS (Master)

### Services → UPS

```
UPS Mode:           Master
Driver:             usbhid-ups
Port:               auto
Shutdown Mode:      UPS reaches low battery
Shutdown Timer:     30 seconds
Shutdown Command:   /sbin/shutdown -p now
Monitor User:       upsmon
Monitor Password:   <secure-password>
Extra Users:        (для slaves)
Remote Monitor:     ✓ Enabled
```

### Allowed Networks

```
10.0.10.0/24        # Management VLAN (Proxmox hosts)
```

---

## Конфигурация Proxmox (Slaves)

### Установка NUT

```bash
apt update
apt install -y nut
```

### /etc/nut/nut.conf

```ini
MODE=netclient
```

### /etc/nut/upsmon.conf

```ini
MONITOR ups@10.0.30.10 1 upsmon <password> slave

MINSUPPLIES 1
SHUTDOWNCMD "/sbin/shutdown -h +0"
POLLFREQ 5
POLLFREQALERT 5
HOSTSYNC 15
DEADTIME 15
POWERDOWNFLAG /etc/killpower

NOTIFYCMD /usr/sbin/upssched
NOTIFYFLAG ONLINE     SYSLOG+WALL
NOTIFYFLAG ONBATT     SYSLOG+WALL
NOTIFYFLAG LOWBATT    SYSLOG+WALL
NOTIFYFLAG FSD        SYSLOG+WALL
NOTIFYFLAG SHUTDOWN   SYSLOG+WALL
```

### Запуск

```bash
systemctl enable nut-client
systemctl start nut-client
systemctl status nut-client
```

---

## Проверка

### На Master (TrueNAS)

```bash
upsc ups@localhost
upsc ups@localhost ups.status
# Ожидаем: OL (Online) или OB (On Battery)
```

### На Slaves (Proxmox)

```bash
upsc ups@10.0.30.10
upsmon -c fsd  # ОСТОРОЖНО! Триггерит shutdown!
```

### Статус батареи

```bash
upsc ups@10.0.30.10 battery.charge
upsc ups@10.0.30.10 battery.runtime
```

---

## Сценарий отключения питания

```
Время T+0:    Питание пропало
              UPS переключился на батарею
              NUT Master: ups.status = OB (On Battery)

Время T+X:    Батарея достигает low battery
              NUT Master: ups.status = OB LB

              NUT Master → отправляет FSD всем slaves

Время T+X+15: Slaves начинают shutdown
              - Proxmox ноды корректно останавливают VMs
              - HA отключается (prevent migration)

Время T+X+30: Slaves выключены
              NUT Master выполняет свой shutdown

Время T+X+45: TrueNAS выключен
              UPS продолжает питать до разряда
```

---

## Мониторинг UPS

### Prometheus + Node Exporter

```yaml
# Добавить в prometheus scrape config
- job_name: "nut"
  static_configs:
    - targets: ["10.0.30.10:9199"] # NUT exporter
```

### Grafana Dashboard

- UPS Status (Online/Battery)
- Battery Charge %
- Load %
- Runtime remaining
- Input/Output voltage

---

## Тестирование

### Безопасный тест

```bash
# На TrueNAS - симуляция low battery
upsmon -c fsd

# ВНИМАНИЕ: Это реально запустит shutdown всего кластера!
```

### Рекомендуемый тест

1. Выключить одну Proxmox ноду
2. Отключить UPS от сети
3. Наблюдать за статусом
4. Подключить UPS обратно ДО low battery
5. Включить ноду

---

## Troubleshooting

### NUT не подключается

```bash
# Проверить firewall
nc -zv 10.0.30.10 3493

# Проверить credentials
grep -i monitor /etc/nut/upsmon.conf
```

### UPS не определяется

```bash
# На TrueNAS
lsusb | grep -i ups
dmesg | grep -i ups
```

---

## Статус

- [x] UPS подключен к TrueNAS
- [x] NUT Master настроен
- [x] NUT Slaves на всех Proxmox нодах
- [x] Тест shutdown проведён
- [ ] Мониторинг в Grafana

---

Дата создания: 02-12-2025 18:22

#### Ссылки:

[[21.08.00 Операции]]
[[21.01.04 Питание и стойка]]
[[21.01.03 TrueNAS]]
