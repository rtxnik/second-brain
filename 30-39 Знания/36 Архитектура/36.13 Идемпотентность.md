# 36.13 Идемпотентность

Идемпотентность — это свойство операции давать одинаковый результат при однократном и многократном выполнении. **В DevOps идемпотентность обеспечивает предсказуемость и безопасность автоматизации, позволяя многократно применять конфигурации без нежелательных побочных эффектов**.

Математически операция f является идемпотентной, если f(f(x)) = f(x). То есть применение функции к результату ее же выполнения не изменяет результат. Это фундаментальное свойство обеспечивает стабильность автоматизированных систем.

Идемпотентные операции можно выполнять повторно без страха нарушить систему или получить неожиданный результат. Это критически важно для automation, где процессы могут прерываться и перезапускаться.

## Примеры идемпотентных операций

**HTTP методы:**

- GET — чтение данных не изменяет состояние
- PUT — полная замена ресурса дает тот же результат
- DELETE — удаление несуществующего не меняет состояние

### Ansible задачи

```yaml
- name: Ensure nginx is installed
  package:
    name: nginx
    state: present # Идемпотентно: установит только если не установлен

- name: Ensure service is running
  service:
    name: nginx
    state: started # Идемпотентно: запустит только если не запущен
```

### Файловые операции

```bash
# Идемпотентное создание директории
mkdir -p /opt/app

# Идемпотентная установка пакета
apt install nginx  # Не переустановит, если уже установлен
```

## Применение в DevOps

[[34.01.00 Ansible|Ansible]] задачи проектируются идемпотентными по умолчанию. Установка пакета через `state: present` выполнится только если пакет не установлен. Запуск сервиса через `state: started` произойдет только если сервис остановлен.

**Infrastructure as Code** через Terraform применяет только необходимые изменения после сравнения текущего и желаемого состояния.

**Kubernetes** постоянно приводит систему к desired state через reconciliation loops.

**CI/CD пайплайны** безопасно перезапускаются на любом этапе.

## Неидемпотентные операции и их исправление

### Проблемные операции

```bash
# Неидемпотентно: каждый раз добавляет строку
echo "export PATH=$PATH:/opt/bin" >> ~/.bashrc

# Неидемпотентно: создает новые файлы
cp file.txt file_$(date +%s).txt

# Неидемпотентно: многократно увеличивает значение
counter=$((counter + 1))
```

### Как сделать идемпотентными

```bash
# Проверить существование перед добавлением
if ! grep -q "/opt/bin" ~/.bashrc; then
    echo "export PATH=$PATH:/opt/bin" >> ~/.bashrc
fi

# Использовать фиксированные имена
cp file.txt backup_file.txt

# Устанавливать абсолютное значение
counter=5
```

## Тестирование идемпотентности

```bash
# Тест: запустить дважды и сравнить результат
ansible-playbook site.yml
RESULT1=$(check_system_state)

ansible-playbook site.yml
RESULT2=$(check_system_state)

if [ "$RESULT1" = "$RESULT2" ]; then
    echo "✅ Playbook is idempotent"
else
    echo "❌ Playbook is NOT idempotent"
fi
```

## Преимущества

- Безопасность повторного выполнения операций
- Отказоустойчивость через легкое восстановление после сбоев
- Простота отладки через перезапуск процессов
- Консистентность приведения к нужному состоянию
- Возможность безопасной автоматизации

## Проектирование идемпотентных систем

Ключевые принципы:

- Проверка текущего состояния перед изменениями
- Использование атомарных операций "все или ничего"
- Применение [[36.12 Декларативность|декларативного подхода]]
- Флаги типа CREATE IF NOT EXISTS, UPDATE WHERE

---

Дата создания: 2025-12-01
Ссылки:

[[36.00 Архитектура]]
[[36.11 Императивность]]
[[36.12 Декларативность]]
[[34.01.00 Ansible]]
